{% extends "base.html" %}

{% block title %}Real-time Processing - AI Chief of Staff{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">
            <i class="fas fa-bolt me-2"></i>
            Real-time Processing Dashboard
        </h1>
        <p class="text-muted mb-0">Monitor and control live data processing</p>
    </div>
    <div>
        <button class="btn btn-enhanced" id="toggleProcessingBtn" onclick="toggleRealtimeProcessing()">
            <i class="fas fa-play me-2"></i>Start Processing
        </button>
        <button class="btn btn-outline-secondary ms-2" onclick="clearQueue()">
            <i class="fas fa-trash me-2"></i>Clear Queue
        </button>
    </div>
</div>

<!-- Status Cards -->
<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="stat-card" id="processingStatusCard">
            <div class="d-flex justify-content-between">
                <div>
                    <div class="stat-value">
                        <span id="processingStatus">Stopped</span>
                    </div>
                    <div class="stat-label">Processing Status</div>
                </div>
                <div class="align-self-center">
                    <i class="fas fa-power-off fa-2x opacity-75" id="statusIcon"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="d-flex justify-content-between">
                <div>
                    <div class="stat-value" id="queueSize">0</div>
                    <div class="stat-label">Queue Size</div>
                </div>
                <div class="align-self-center">
                    <i class="fas fa-list fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="d-flex justify-content-between">
                <div>
                    <div class="stat-value" id="processedToday">0</div>
                    <div class="stat-label">Processed Today</div>
                </div>
                <div class="align-self-center">
                    <i class="fas fa-check-circle fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <div class="d-flex justify-content-between">
                <div>
                    <div class="stat-value" id="avgProcessingTime">0ms</div>
                    <div class="stat-label">Avg Processing Time</div>
                </div>
                <div class="align-self-center">
                    <i class="fas fa-stopwatch fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Processing Controls -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs me-2"></i>Processing Controls
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="processingMode" class="form-label">Processing Mode</label>
                        <select id="processingMode" class="form-select" onchange="updateProcessingMode()">
                            <option value="automatic">Automatic</option>
                            <option value="manual">Manual</option>
                            <option value="scheduled">Scheduled</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="batchSize" class="form-label">Batch Size</label>
                        <input type="number" id="batchSize" class="form-control" value="10" min="1" max="100" onchange="updateBatchSize()">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="processingInterval" class="form-label">Processing Interval (seconds)</label>
                        <input type="number" id="processingInterval" class="form-control" value="30" min="10" max="300" onchange="updateProcessingInterval()">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="priorityMode" class="form-label">Priority Mode</label>
                        <select id="priorityMode" class="form-select" onchange="updatePriorityMode()">
                            <option value="fifo">First In, First Out</option>
                            <option value="priority">High Priority First</option>
                            <option value="smart">Smart Prioritization</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Live Activity Monitor -->
<div class="row mb-4">
    <div class="col-md-8 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-activity me-2"></i>Live Activity Feed
                </h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearActivityFeed()">
                    <i class="fas fa-broom me-2"></i>Clear
                </button>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="activityFeed">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-satellite-dish fa-2x mb-2"></i>
                        <p>Waiting for activity...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-area me-2"></i>Performance Metrics
                </h5>
            </div>
            <div class="card-body">
                <canvas id="performanceChart" width="300" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Processing Queue -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list-ol me-2"></i>Processing Queue
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshQueue()">
                        <i class="fas fa-sync me-2"></i>Refresh
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="pauseQueue()">
                        <i class="fas fa-pause me-2"></i>Pause
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="queueItems">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <p>Queue is empty</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Insights -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Real-time Insights
                </h5>
            </div>
            <div class="card-body">
                <div id="realtimeInsights">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-brain fa-2x mb-2"></i>
                        <p>Start processing to see real-time insights</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .activity-item {
        border-left: 4px solid var(--primary-color);
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        transition: all 0.3s;
        animation: slideIn 0.5s ease-in;
    }
    
    .activity-item.processing {
        border-left-color: var(--warning-color);
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    }
    
    .activity-item.completed {
        border-left-color: var(--success-color);
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    }
    
    .activity-item.error {
        border-left-color: var(--accent-color);
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    .queue-item {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        background: white;
        transition: all 0.3s;
    }
    
    .queue-item:hover {
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .queue-item.priority-high {
        border-left: 4px solid var(--accent-color);
    }
    
    .queue-item.priority-medium {
        border-left: 4px solid var(--warning-color);
    }
    
    .queue-item.priority-low {
        border-left: 4px solid var(--info-color);
    }
    
    .real-time-badge {
        animation: pulse 2s infinite;
        background: linear-gradient(45deg, var(--success-color), var(--info-color));
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }
    
    .status-indicator.active {
        background-color: var(--success-color);
        animation: pulse 2s infinite;
    }
    
    .status-indicator.inactive {
        background-color: var(--secondary);
    }
    
    .status-indicator.error {
        background-color: var(--accent-color);
        animation: blink 1s infinite;
    }
    
    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0.3; }
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Real-time processing functionality
    let processingActive = false;
    let activityItems = [];
    let queueItems = [];
    let performanceChart;
    let performanceData = [];
    
    // Initialize real-time dashboard
    document.addEventListener('DOMContentLoaded', function() {
        initializePerformanceChart();
        loadInitialStatus();
        setupWebSocketListeners();
        
        // Auto-refresh data every 30 seconds
        setInterval(refreshDashboard, 30000);
    });
    
    // Initialize performance chart
    function initializePerformanceChart() {
        const ctx = document.getElementById('performanceChart').getContext('2d');
        performanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Processing Rate',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        beginAtZero: true,
                        title: { display: true, text: 'Items/min' }
                    },
                    x: {
                        title: { display: true, text: 'Time' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
    
    // Load initial status
    async function loadInitialStatus() {
        try {
            const response = await axios.get('/api/realtime/status');
            if (response.data.success) {
                updateStatus(response.data.data);
            }
        } catch (error) {
            console.error('Error loading initial status:', error);
        }
        
        // Load queue status
        try {
            const queueResponse = await axios.get('/api/realtime/queue/status');
            if (queueResponse.data.success) {
                updateQueueDisplay(queueResponse.data.data);
            }
        } catch (error) {
            console.error('Error loading queue status:', error);
        }
    }
    
    // Setup WebSocket listeners
    function setupWebSocketListeners() {
        if (typeof socket !== 'undefined') {
            socket.on('processing_started', function(data) {
                addActivityItem('Processing started', 'processing', data.timestamp);
                updateProcessingStatus(true);
            });
            
            socket.on('processing_stopped', function(data) {
                addActivityItem('Processing stopped', 'completed', data.timestamp);
                updateProcessingStatus(false);
            });
            
            socket.on('item_processed', function(data) {
                addActivityItem(`Processed: ${data.type} - ${data.description}`, 'completed', data.timestamp);
                updatePerformanceChart();
                updateMetrics();
            });
            
            socket.on('processing_error', function(data) {
                addActivityItem(`Error: ${data.error}`, 'error', data.timestamp);
            });
            
            socket.on('queue_updated', function(data) {
                updateQueueDisplay(data);
            });
            
            socket.on('insight_ready', function(data) {
                addRealtimeInsight(data);
            });
        }
    }
    
    // Toggle real-time processing
    async function toggleRealtimeProcessing() {
        try {
            const endpoint = processingActive ? '/api/realtime/stop' : '/api/realtime/start';
            const response = await axios.post(endpoint);
            
            if (response.data.success) {
                processingActive = !processingActive;
                updateProcessingButton();
                showAlert(`Real-time processing ${processingActive ? 'started' : 'stopped'}!`, 'success');
            } else {
                showAlert('Failed to toggle processing: ' + response.data.error, 'danger');
            }
        } catch (error) {
            showAlert('Error toggling processing: ' + error.message, 'danger');
        }
    }
    
    // Update processing status
    function updateProcessingStatus(active) {
        processingActive = active;
        updateProcessingButton();
        
        const statusCard = document.getElementById('processingStatusCard');
        const statusText = document.getElementById('processingStatus');
        const statusIcon = document.getElementById('statusIcon');
        
        if (active) {
            statusCard.style.background = 'linear-gradient(135deg, #27ae60 0%, #2ecc71 100%)';
            statusText.textContent = 'Active';
            statusIcon.className = 'fas fa-play fa-2x opacity-75';
        } else {
            statusCard.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            statusText.textContent = 'Stopped';
            statusIcon.className = 'fas fa-power-off fa-2x opacity-75';
        }
    }
    
    // Update processing button
    function updateProcessingButton() {
        const btn = document.getElementById('toggleProcessingBtn');
        if (processingActive) {
            btn.innerHTML = '<i class="fas fa-stop me-2"></i>Stop Processing';
            btn.className = 'btn btn-outline-danger';
        } else {
            btn.innerHTML = '<i class="fas fa-play me-2"></i>Start Processing';
            btn.className = 'btn btn-enhanced';
        }
    }
    
    // Add activity item
    function addActivityItem(message, type, timestamp) {
        const activityFeed = document.getElementById('activityFeed');
        
        // Create new activity item
        const item = document.createElement('div');
        item.className = `activity-item ${type}`;
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="fw-bold">${message}</div>
                    <small class="text-muted">${new Date(timestamp || Date.now()).toLocaleTimeString()}</small>
                </div>
                <span class="status-indicator ${type === 'completed' ? 'active' : type === 'error' ? 'error' : 'inactive'}"></span>
            </div>
        `;
        
        // Add to beginning of feed
        if (activityFeed.children.length === 1 && activityFeed.children[0].querySelector('.text-muted')) {
            activityFeed.innerHTML = '';
        }
        
        activityFeed.insertBefore(item, activityFeed.firstChild);
        
        // Keep only last 20 items
        while (activityFeed.children.length > 20) {
            activityFeed.removeChild(activityFeed.lastChild);
        }
        
        activityItems.unshift({ message, type, timestamp: timestamp || Date.now() });
        if (activityItems.length > 50) activityItems.pop();
    }
    
    // Update performance chart
    function updatePerformanceChart() {
        const now = new Date();
        const timeLabel = now.toLocaleTimeString();
        
        // Add current processing rate
        const currentRate = calculateCurrentProcessingRate();
        performanceData.push({ time: timeLabel, rate: currentRate });
        
        // Keep only last 20 data points
        if (performanceData.length > 20) {
            performanceData.shift();
        }
        
        performanceChart.data.labels = performanceData.map(d => d.time);
        performanceChart.data.datasets[0].data = performanceData.map(d => d.rate);
        performanceChart.update();
    }
    
    // Calculate current processing rate
    function calculateCurrentProcessingRate() {
        const lastMinute = Date.now() - 60000;
        const recentItems = activityItems.filter(item => 
            item.timestamp > lastMinute && item.type === 'completed'
        );
        return recentItems.length;
    }
    
    // Update queue display
    function updateQueueDisplay(queueData) {
        const container = document.getElementById('queueItems');
        const sizeElement = document.getElementById('queueSize');
        
        if (!queueData || !queueData.items || queueData.items.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p>Queue is empty</p>
                </div>
            `;
            sizeElement.textContent = '0';
            return;
        }
        
        sizeElement.textContent = queueData.items.length;
        
        container.innerHTML = queueData.items.slice(0, 10).map(item => `
            <div class="queue-item priority-${item.priority || 'medium'}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${item.type}: ${item.description}</h6>
                        <small class="text-muted">
                            Added: ${new Date(item.created_at).toLocaleTimeString()}
                            | Priority: ${item.priority || 'medium'}
                        </small>
                    </div>
                    <span class="badge bg-${getPriorityColor(item.priority)}">${item.priority || 'medium'}</span>
                </div>
            </div>
        `).join('');
        
        if (queueData.items.length > 10) {
            container.innerHTML += `
                <div class="text-center text-muted py-2">
                    <small>... and ${queueData.items.length - 10} more items</small>
                </div>
            `;
        }
    }
    
    // Add real-time insight
    function addRealtimeInsight(insight) {
        const container = document.getElementById('realtimeInsights');
        
        if (container.children.length === 1 && container.children[0].querySelector('.text-muted')) {
            container.innerHTML = '';
        }
        
        const insightElement = document.createElement('div');
        insightElement.className = 'insight-card';
        insightElement.innerHTML = `
            <h6 class="mb-2">
                <span class="real-time-badge badge bg-success me-2">LIVE</span>
                ${insight.title}
            </h6>
            <p class="mb-2">${insight.description}</p>
            <div class="d-flex justify-content-between align-items-center">
                <span class="badge bg-${getPriorityColor(insight.priority)}">${insight.priority}</span>
                <small class="text-muted">Just now</small>
            </div>
        `;
        
        container.insertBefore(insightElement, container.firstChild);
        
        // Keep only last 5 insights
        while (container.children.length > 5) {
            container.removeChild(container.lastChild);
        }
    }
    
    // Update status metrics
    function updateStatus(statusData) {
        if (statusData.processing_active !== undefined) {
            updateProcessingStatus(statusData.processing_active);
        }
        
        if (statusData.processed_today !== undefined) {
            document.getElementById('processedToday').textContent = statusData.processed_today;
        }
        
        if (statusData.avg_processing_time !== undefined) {
            document.getElementById('avgProcessingTime').textContent = statusData.avg_processing_time + 'ms';
        }
    }
    
    // Update metrics
    function updateMetrics() {
        // Update processed today counter
        const processed = activityItems.filter(item => {
            const today = new Date().toDateString();
            return new Date(item.timestamp).toDateString() === today && item.type === 'completed';
        }).length;
        
        document.getElementById('processedToday').textContent = processed;
        
        // Update average processing time (mock data)
        const avgTime = Math.floor(Math.random() * 500) + 100;
        document.getElementById('avgProcessingTime').textContent = avgTime + 'ms';
    }
    
    // Control functions
    function updateProcessingMode() {
        const mode = document.getElementById('processingMode').value;
        // Send to API
        console.log('Processing mode changed to:', mode);
    }
    
    function updateBatchSize() {
        const size = document.getElementById('batchSize').value;
        // Send to API
        console.log('Batch size changed to:', size);
    }
    
    function updateProcessingInterval() {
        const interval = document.getElementById('processingInterval').value;
        // Send to API
        console.log('Processing interval changed to:', interval);
    }
    
    function updatePriorityMode() {
        const mode = document.getElementById('priorityMode').value;
        // Send to API
        console.log('Priority mode changed to:', mode);
    }
    
    function clearQueue() {
        if (confirm('Are you sure you want to clear the processing queue?')) {
            // API call to clear queue
            showAlert('Queue cleared!', 'warning');
        }
    }
    
    function clearActivityFeed() {
        const activityFeed = document.getElementById('activityFeed');
        activityFeed.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-satellite-dish fa-2x mb-2"></i>
                <p>Waiting for activity...</p>
            </div>
        `;
        activityItems = [];
    }
    
    function refreshQueue() {
        loadInitialStatus();
    }
    
    function pauseQueue() {
        // API call to pause queue
        showAlert('Queue paused!', 'info');
    }
    
    function refreshDashboard() {
        if (processingActive) {
            loadInitialStatus();
        }
    }
    
    // Utility functions
    function getPriorityColor(priority) {
        switch(priority) {
            case 'high': return 'danger';
            case 'medium': return 'warning';
            case 'low': return 'info';
            default: return 'secondary';
        }
    }
</script>
{% endblock %} 