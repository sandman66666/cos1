{% extends "base.html" %}

{% block title %}Calendar Intelligence{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h2 class="h4 mb-0">
                <i class="fas fa-calendar me-2"></i>Calendar Intelligence
            </h2>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" onclick="syncCalendar()">
                <i class="fas fa-sync me-2"></i>Sync Calendar
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Total Events</h5>
                    <h2 id="totalEvents">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Upcoming Meetings</h5>
                    <h2 id="upcomingMeetings">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Need Preparation</h5>
                    <h2 id="needPreparation">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Strategic Events</h5>
                    <h2 id="strategicEvents">0</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Events -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Upcoming Events</h5>
            <div>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleView('list')" id="listViewBtn">
                    <i class="fas fa-list"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary ms-1" onclick="toggleView('calendar')" id="calendarViewBtn">
                    <i class="fas fa-calendar"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            <div id="eventsContainer">
                <div class="text-center text-muted py-5">
                    <i class="fas fa-calendar fa-3x mb-3"></i>
                    <p>Loading events...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // State variables
    let currentEvents = [];
    let currentView = 'list';

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadCalendarEvents();
    });

    // Load calendar events
    async function loadCalendarEvents() {
        try {
            showLoading();
            const response = await axios.get('/api/calendar/events', {
                params: {
                    days_forward: 14,
                    limit: 50
                }
            });
            
            hideLoading();
            
            if (response.data.success) {
                currentEvents = response.data.events || [];
                updateStatistics();
                renderEvents();
            } else {
                showAlert('Failed to load events: ' + response.data.error, 'danger');
            }
        } catch (error) {
            hideLoading();
            showAlert('Error loading events: ' + error.message, 'danger');
        }
    }

    // Sync calendar
    async function syncCalendar() {
        try {
            showLoading();
            showAlert('Syncing calendar...', 'info');
            
            const response = await axios.post('/api/calendar/sync', {
                days_back: 30,
                days_forward: 30
            });
            
            hideLoading();
            
            if (response.data.success) {
                showAlert(`Successfully synced ${response.data.events_fetched} calendar events!`, 'success');
                loadCalendarEvents(); // Reload events
            } else {
                showAlert('Failed to sync calendar: ' + response.data.error, 'danger');
            }
        } catch (error) {
            hideLoading();
            showAlert('Error syncing calendar: ' + error.message, 'danger');
        }
    }

    // Update statistics
    function updateStatistics() {
        const now = new Date();
        
        document.getElementById('totalEvents').textContent = currentEvents.length;
        
        const upcomingMeetings = currentEvents.filter(event => 
            new Date(event.start_time) > now
        ).length;
        document.getElementById('upcomingMeetings').textContent = upcomingMeetings;
        
        const needPrep = currentEvents.filter(event => 
            event.preparation_needed || (event.attendees && event.attendees.length > 2)
        ).length;
        document.getElementById('needPreparation').textContent = needPrep;
        
        const strategic = currentEvents.filter(event => 
            event.importance_score >= 0.7 || (event.attendees && event.attendees.length > 3)
        ).length;
        document.getElementById('strategicEvents').textContent = strategic;
    }

    // Toggle between list and calendar view
    function toggleView(view) {
        currentView = view;
        document.getElementById('listViewBtn').classList.toggle('btn-primary', view === 'list');
        document.getElementById('listViewBtn').classList.toggle('btn-outline-secondary', view !== 'list');
        document.getElementById('calendarViewBtn').classList.toggle('btn-primary', view === 'calendar');
        document.getElementById('calendarViewBtn').classList.toggle('btn-outline-secondary', view !== 'calendar');
        renderEvents();
    }

    // Render events based on current view
    function renderEvents() {
        const container = document.getElementById('eventsContainer');
        
        if (currentEvents.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-calendar fa-3x mb-3"></i>
                    <p>No events found. Try syncing your calendar.</p>
                </div>
            `;
            return;
        }
        
        if (currentView === 'list') {
            container.innerHTML = currentEvents.map(event => `
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">${event.title}</h5>
                        <div class="text-muted mb-2">
                            <i class="fas fa-clock me-1"></i>${formatDateTime(event.start_time)}
                            ${event.location ? `<br><i class="fas fa-map-marker-alt me-1"></i>${event.location}` : ''}
                        </div>
                        <div class="d-flex gap-2">
                            <span class="badge bg-primary">
                                <i class="fas fa-users me-1"></i>${event.attendees ? event.attendees.length : 0} attendees
                            </span>
                            ${event.meeting_type === 'video_call' ? `
                                <span class="badge bg-info">
                                    <i class="fas fa-video me-1"></i>Video Call
                                </span>
                            ` : ''}
                            ${event.is_recurring ? `
                                <span class="badge bg-secondary">
                                    <i class="fas fa-redo me-1"></i>Recurring
                                </span>
                            ` : ''}
                            ${event.preparation_needed ? `
                                <span class="badge bg-warning">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Needs Preparation
                                </span>
                            ` : ''}
                        </div>
                        ${event.description ? `
                            <div class="mt-2 small text-muted">
                                ${event.description.substring(0, 200)}${event.description.length > 200 ? '...' : ''}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-calendar fa-3x mb-3"></i>
                    <p>Calendar view coming soon!</p>
                </div>
            `;
        }
    }

    // Helper function to format date/time
    function formatDateTime(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit'
        });
    }
</script>
{% endblock %} 