{% extends "base.html" %}

{% block title %}API Testing Interface - AI Chief of Staff{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">
            <i class="fas fa-vial me-2"></i>
            API Testing Interface
        </h1>
        <p class="text-muted mb-0">Interactive testing for all AI Chief of Staff APIs</p>
    </div>
    <div>
        <button class="btn btn-enhanced" onclick="loadApiDocumentation()">
            <i class="fas fa-book me-2"></i>Load Documentation
        </button>
        <button class="btn btn-outline-primary ms-2" onclick="exportTestResults()">
            <i class="fas fa-download me-2"></i>Export Results
        </button>
    </div>
</div>

<!-- API Explorer Navigation -->
<ul class="nav nav-tabs mb-4" id="apiTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="explorer-tab" data-bs-toggle="tab" data-bs-target="#explorer" type="button" role="tab">
            <i class="fas fa-rocket me-2"></i>API Explorer
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="endpoints-tab" data-bs-toggle="tab" data-bs-target="#endpoints" type="button" role="tab">
            <i class="fas fa-list me-2"></i>Endpoints
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="schemas-tab" data-bs-toggle="tab" data-bs-target="#schemas" type="button" role="tab">
            <i class="fas fa-code me-2"></i>Schemas
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results" type="button" role="tab">
            <i class="fas fa-chart-bar me-2"></i>Test Results
        </button>
    </li>
</ul>

<div class="tab-content" id="apiTabContent">
    <!-- API Explorer Tab -->
    <div class="tab-pane fade show active" id="explorer" role="tabpanel">
        <div class="row">
            <!-- Request Builder -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-cogs me-2"></i>Request Builder
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Method and URL -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="requestMethod" class="form-label">Method</label>
                                <select id="requestMethod" class="form-select">
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                </select>
                            </div>
                            <div class="col-md-9">
                                <label for="requestUrl" class="form-label">Endpoint URL</label>
                                <div class="input-group">
                                    <span class="input-group-text">{{ request.host_url }}</span>
                                    <input type="text" id="requestUrl" class="form-control" placeholder="/api/v2/..." value="/api/status">
                                </div>
                            </div>
                        </div>

                        <!-- Headers -->
                        <div class="mb-3">
                            <label class="form-label">Headers</label>
                            <div id="headersContainer">
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" placeholder="Header Name" value="Content-Type">
                                    <input type="text" class="form-control" placeholder="Header Value" value="application/json">
                                    <button class="btn btn-outline-secondary" onclick="removeHeader(this)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="addHeader()">
                                <i class="fas fa-plus me-2"></i>Add Header
                            </button>
                        </div>

                        <!-- Request Body -->
                        <div class="mb-3">
                            <label for="requestBody" class="form-label">Request Body (JSON)</label>
                            <textarea id="requestBody" class="form-control" rows="8" placeholder='{"key": "value"}'></textarea>
                        </div>

                        <!-- Quick Endpoint Selector -->
                        <div class="mb-3">
                            <label for="quickEndpoint" class="form-label">Quick Select</label>
                            <select id="quickEndpoint" class="form-select" onchange="loadQuickEndpoint()">
                                <option value="">Select a common endpoint...</option>
                                <option value="GET|/api/status">API Status</option>
                                <option value="GET|/api/v2/status">Enhanced Status</option>
                                <option value="GET|/api/entities/people">List People</option>
                                <option value="POST|/api/entities/people">Create Person</option>
                                <option value="GET|/api/analytics/insights/comprehensive">Get Insights</option>
                                <option value="POST|/api/realtime/start">Start Real-time</option>
                                <option value="POST|/api/process-emails">Process Emails</option>
                                <option value="GET|/api/tasks">List Tasks</option>
                            </select>
                        </div>

                        <!-- Execute Button -->
                        <div class="d-grid">
                            <button class="btn btn-enhanced btn-lg" onclick="executeRequest()">
                                <i class="fas fa-play me-2"></i>Execute Request
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Response Viewer -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-terminal me-2"></i>Response
                        </h5>
                        <div>
                            <span id="responseStatus" class="badge bg-secondary">Ready</span>
                            <span id="responseTime" class="badge bg-info ms-1">0ms</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Response Headers -->
                        <div class="mb-3">
                            <label class="form-label">Response Headers</label>
                            <div id="responseHeaders" class="border rounded p-2" style="min-height: 60px; background-color: #f8f9fa;">
                                <small class="text-muted">Execute a request to see headers</small>
                            </div>
                        </div>

                        <!-- Response Body -->
                        <div class="mb-3">
                            <label class="form-label">Response Body</label>
                            <div class="d-flex mb-2">
                                <button class="btn btn-sm btn-outline-secondary me-2" onclick="formatResponseJson()">
                                    <i class="fas fa-code me-1"></i>Format JSON
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="copyResponse()">
                                    <i class="fas fa-copy me-1"></i>Copy
                                </button>
                            </div>
                            <pre id="responseBody" class="border rounded p-3" style="min-height: 200px; background-color: #f8f9fa; overflow-x: auto;"><small class="text-muted">Execute a request to see response</small></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Request History -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-history me-2"></i>Request History
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearHistory()">
                            <i class="fas fa-trash me-2"></i>Clear History
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="requestHistory">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-clock fa-2x mb-2"></i>
                                <p>No requests made yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Endpoints Tab -->
    <div class="tab-pane fade" id="endpoints" role="tabpanel">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Available API Endpoints</h5>
                    </div>
                    <div class="card-body">
                        <div id="endpointsList">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                <p>Loading endpoints...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Schemas Tab -->
    <div class="tab-pane fade" id="schemas" role="tabpanel">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">API Schemas</h5>
                    </div>
                    <div class="card-body">
                        <div id="schemasList">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                <p>Loading schemas...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Results Tab -->
    <div class="tab-pane fade" id="results" role="tabpanel">
        <div class="row mb-4">
            <!-- Test Statistics -->
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="stat-card">
                    <div class="stat-value" id="totalRequests">0</div>
                    <div class="stat-label">Total Requests</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);">
                    <div class="stat-value" id="successfulRequests">0</div>
                    <div class="stat-label">Successful</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                    <div class="stat-value" id="failedRequests">0</div>
                    <div class="stat-label">Failed</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                    <div class="stat-value" id="avgResponseTime">0ms</div>
                    <div class="stat-label">Avg Response Time</div>
                </div>
            </div>
        </div>

        <!-- Test Results Chart -->
        <div class="row">
            <div class="col-md-8 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Response Time Trends</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="responseTimeChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Status Code Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="statusCodeChart" width="200" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .endpoint-item {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: white;
        transition: all 0.3s;
    }
    
    .endpoint-item:hover {
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .method-badge {
        font-size: 0.8rem;
        font-weight: bold;
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        text-transform: uppercase;
    }
    
    .method-get { background-color: #28a745; color: white; }
    .method-post { background-color: #007bff; color: white; }
    .method-put { background-color: #ffc107; color: black; }
    .method-delete { background-color: #dc3545; color: white; }
    
    .history-item {
        border-left: 4px solid var(--primary-color);
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        transition: all 0.3s;
        cursor: pointer;
    }
    
    .history-item:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .history-item.success {
        border-left-color: var(--success-color);
    }
    
    .history-item.error {
        border-left-color: var(--accent-color);
    }
    
    .code-block {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 1rem;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        overflow-x: auto;
    }
    
    .schema-item {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: white;
    }
    
    .response-status-200 { color: #28a745; }
    .response-status-400 { color: #ffc107; }
    .response-status-500 { color: #dc3545; }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // API Testing functionality
    let requestHistory = [];
    let testStats = { total: 0, successful: 0, failed: 0, totalTime: 0 };
    let responseTimeChart, statusCodeChart;
    
    // Initialize API testing interface
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
        loadEndpoints();
        loadSchemas();
        
        // Tab change handlers
        document.getElementById('endpoints-tab').addEventListener('click', loadEndpoints);
        document.getElementById('schemas-tab').addEventListener('click', loadSchemas);
    });
    
    // Initialize charts
    function initializeCharts() {
        // Response Time Chart
        const rtCtx = document.getElementById('responseTimeChart').getContext('2d');
        responseTimeChart = new Chart(rtCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Response Time (ms)',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } }
            }
        });
        
        // Status Code Chart
        const scCtx = document.getElementById('statusCodeChart').getContext('2d');
        statusCodeChart = new Chart(scCtx, {
            type: 'doughnut',
            data: {
                labels: ['200 OK', '400 Bad Request', '500 Server Error', 'Other'],
                datasets: [{
                    data: [0, 0, 0, 0],
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#6c757d']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
    
    // Execute API request
    async function executeRequest() {
        const method = document.getElementById('requestMethod').value;
        const url = document.getElementById('requestUrl').value;
        const body = document.getElementById('requestBody').value;
        
        // Collect headers
        const headers = {};
        const headerInputs = document.querySelectorAll('#headersContainer .input-group');
        headerInputs.forEach(group => {
            const nameInput = group.querySelector('input:first-child');
            const valueInput = group.querySelector('input:nth-child(2)');
            if (nameInput.value && valueInput.value) {
                headers[nameInput.value] = valueInput.value;
            }
        });
        
        // Show loading
        document.getElementById('responseStatus').textContent = 'Loading...';
        document.getElementById('responseStatus').className = 'badge bg-warning';
        
        const startTime = Date.now();
        
        try {
            const config = {
                method: method,
                url: url,
                headers: headers
            };
            
            if (method !== 'GET' && body) {
                try {
                    config.data = JSON.parse(body);
                } catch (e) {
                    config.data = body;
                }
            }
            
            const response = await axios(config);
            const endTime = Date.now();
            const responseTime = endTime - startTime;
            
            // Update response display
            updateResponseDisplay(response, responseTime, true);
            
            // Add to history
            addToHistory(method, url, response.status, responseTime, true, response.data);
            
            // Update statistics
            updateTestStatistics(true, responseTime, response.status);
            
        } catch (error) {
            const endTime = Date.now();
            const responseTime = endTime - startTime;
            
            // Update response display with error
            updateResponseDisplay(error.response || error, responseTime, false);
            
            // Add to history
            addToHistory(method, url, error.response?.status || 0, responseTime, false, error.response?.data || error.message);
            
            // Update statistics
            updateTestStatistics(false, responseTime, error.response?.status || 0);
        }
    }
    
    // Update response display
    function updateResponseDisplay(response, responseTime, success) {
        const statusElement = document.getElementById('responseStatus');
        const timeElement = document.getElementById('responseTime');
        const headersElement = document.getElementById('responseHeaders');
        const bodyElement = document.getElementById('responseBody');
        
        // Update status
        if (success) {
            statusElement.textContent = `${response.status} ${response.statusText || 'OK'}`;
            statusElement.className = 'badge bg-success';
        } else {
            statusElement.textContent = `${response.status || 'Error'} ${response.statusText || 'Failed'}`;
            statusElement.className = 'badge bg-danger';
        }
        
        // Update time
        timeElement.textContent = `${responseTime}ms`;
        
        // Update headers
        if (response.headers) {
            let headersHtml = '';
            Object.entries(response.headers).forEach(([key, value]) => {
                headersHtml += `<div><strong>${key}:</strong> ${value}</div>`;
            });
            headersElement.innerHTML = headersHtml || '<small class="text-muted">No headers</small>';
        } else {
            headersElement.innerHTML = '<small class="text-muted">No headers available</small>';
        }
        
        // Update body
        if (response.data) {
            try {
                bodyElement.textContent = JSON.stringify(response.data, null, 2);
            } catch (e) {
                bodyElement.textContent = response.data;
            }
        } else {
            bodyElement.textContent = response.message || 'No response body';
        }
    }
    
    // Add request to history
    function addToHistory(method, url, status, responseTime, success, responseData) {
        const historyItem = {
            id: Date.now(),
            timestamp: new Date(),
            method,
            url,
            status,
            responseTime,
            success,
            responseData
        };
        
        requestHistory.unshift(historyItem);
        if (requestHistory.length > 50) requestHistory.pop();
        
        updateHistoryDisplay();
    }
    
    // Update history display
    function updateHistoryDisplay() {
        const container = document.getElementById('requestHistory');
        
        if (requestHistory.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <p>No requests made yet</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = requestHistory.slice(0, 10).map(item => `
            <div class="history-item ${item.success ? 'success' : 'error'}" onclick="loadHistoryItem(${item.id})">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="method-badge method-${item.method.toLowerCase()}">${item.method}</span>
                        <span class="ms-2">${item.url}</span>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-${item.success ? 'success' : 'danger'}">${item.status}</span>
                        <br><small class="text-muted">${item.responseTime}ms | ${item.timestamp.toLocaleTimeString()}</small>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    // Load history item
    function loadHistoryItem(id) {
        const item = requestHistory.find(h => h.id === id);
        if (!item) return;
        
        document.getElementById('requestMethod').value = item.method;
        document.getElementById('requestUrl').value = item.url;
        
        // Show response
        updateResponseDisplay({
            status: item.status,
            statusText: item.success ? 'OK' : 'Error',
            headers: {},
            data: item.responseData
        }, item.responseTime, item.success);
    }
    
    // Update test statistics
    function updateTestStatistics(success, responseTime, statusCode) {
        testStats.total++;
        if (success) testStats.successful++;
        else testStats.failed++;
        testStats.totalTime += responseTime;
        
        // Update display
        document.getElementById('totalRequests').textContent = testStats.total;
        document.getElementById('successfulRequests').textContent = testStats.successful;
        document.getElementById('failedRequests').textContent = testStats.failed;
        document.getElementById('avgResponseTime').textContent = Math.round(testStats.totalTime / testStats.total) + 'ms';
        
        // Update charts
        updateResponseTimeChart(responseTime);
        updateStatusCodeChart(statusCode);
    }
    
    // Update charts
    function updateResponseTimeChart(responseTime) {
        const now = new Date().toLocaleTimeString();
        responseTimeChart.data.labels.push(now);
        responseTimeChart.data.datasets[0].data.push(responseTime);
        
        if (responseTimeChart.data.labels.length > 20) {
            responseTimeChart.data.labels.shift();
            responseTimeChart.data.datasets[0].data.shift();
        }
        
        responseTimeChart.update();
    }
    
    function updateStatusCodeChart(statusCode) {
        let index = 3; // Other
        if (statusCode >= 200 && statusCode < 300) index = 0; // 200 OK
        else if (statusCode >= 400 && statusCode < 500) index = 1; // 400 Bad Request
        else if (statusCode >= 500) index = 2; // 500 Server Error
        
        statusCodeChart.data.datasets[0].data[index]++;
        statusCodeChart.update();
    }
    
    // Header management
    function addHeader() {
        const container = document.getElementById('headersContainer');
        const headerGroup = document.createElement('div');
        headerGroup.className = 'input-group mb-2';
        headerGroup.innerHTML = `
            <input type="text" class="form-control" placeholder="Header Name">
            <input type="text" class="form-control" placeholder="Header Value">
            <button class="btn btn-outline-secondary" onclick="removeHeader(this)">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(headerGroup);
    }
    
    function removeHeader(button) {
        button.closest('.input-group').remove();
    }
    
    // Quick endpoint loader
    function loadQuickEndpoint() {
        const selected = document.getElementById('quickEndpoint').value;
        if (!selected) return;
        
        const [method, url] = selected.split('|');
        document.getElementById('requestMethod').value = method;
        document.getElementById('requestUrl').value = url;
        
        // Set sample data for POST requests
        if (method === 'POST') {
            if (url.includes('/entities/people')) {
                document.getElementById('requestBody').value = JSON.stringify({
                    name: "John Doe",
                    email: "john.doe@example.com",
                    company: "Example Corp",
                    title: "Software Engineer",
                    importance: "medium"
                }, null, 2);
            } else if (url.includes('/process-emails')) {
                document.getElementById('requestBody').value = JSON.stringify({
                    days_back: 7,
                    limit: 50,
                    force_refresh: false
                }, null, 2);
            }
        }
    }
    
    // Load endpoints
    async function loadEndpoints() {
        try {
            const response = await axios.get('/api/docs/endpoints');
            const container = document.getElementById('endpointsList');
            
            if (response.data.success && response.data.data.endpoints) {
                const endpoints = response.data.data.endpoints;
                container.innerHTML = Object.entries(endpoints).map(([category, categoryEndpoints]) => `
                    <div class="mb-4">
                        <h6 class="fw-bold text-primary">${category}</h6>
                        ${categoryEndpoints.map(endpoint => `
                            <div class="endpoint-item" onclick="loadEndpointToBuilder('${endpoint.method}', '${endpoint.path}')">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <span class="method-badge method-${endpoint.method.toLowerCase()}">${endpoint.method}</span>
                                        <span class="ms-2 fw-bold">${endpoint.path}</span>
                                        <p class="mb-1 mt-2">${endpoint.description || 'No description available'}</p>
                                        ${endpoint.parameters ? `<small class="text-muted">Parameters: ${endpoint.parameters.map(p => p.name).join(', ')}</small>` : ''}
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-play me-1"></i>Try It
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-muted">No endpoints available</p>';
            }
        } catch (error) {
            document.getElementById('endpointsList').innerHTML = '<p class="text-danger">Error loading endpoints</p>';
        }
    }
    
    function loadEndpointToBuilder(method, path) {
        document.getElementById('requestMethod').value = method;
        document.getElementById('requestUrl').value = path;
        
        // Switch to explorer tab
        document.getElementById('explorer-tab').click();
    }
    
    // Load schemas
    async function loadSchemas() {
        try {
            const container = document.getElementById('schemasList');
            
            // Mock schema data for now
            const schemas = {
                'Person': {
                    type: 'object',
                    properties: {
                        name: { type: 'string', description: 'Full name' },
                        email: { type: 'string', format: 'email' },
                        company: { type: 'string' },
                        importance: { type: 'string', enum: ['low', 'medium', 'high'] }
                    }
                },
                'Task': {
                    type: 'object',
                    properties: {
                        description: { type: 'string' },
                        status: { type: 'string', enum: ['pending', 'completed'] },
                        priority: { type: 'string', enum: ['low', 'medium', 'high'] }
                    }
                }
            };
            
            container.innerHTML = Object.entries(schemas).map(([name, schema]) => `
                <div class="schema-item">
                    <h6 class="fw-bold">${name}</h6>
                    <div class="code-block">
                        <pre>${JSON.stringify(schema, null, 2)}</pre>
                    </div>
                </div>
            `).join('');
            
        } catch (error) {
            document.getElementById('schemasList').innerHTML = '<p class="text-danger">Error loading schemas</p>';
        }
    }
    
    // Utility functions
    function formatResponseJson() {
        const bodyElement = document.getElementById('responseBody');
        try {
            const parsed = JSON.parse(bodyElement.textContent);
            bodyElement.textContent = JSON.stringify(parsed, null, 2);
        } catch (e) {
            showAlert('Response is not valid JSON', 'warning');
        }
    }
    
    function copyResponse() {
        const bodyElement = document.getElementById('responseBody');
        navigator.clipboard.writeText(bodyElement.textContent).then(() => {
            showAlert('Response copied to clipboard!', 'success');
        });
    }
    
    function clearHistory() {
        if (confirm('Are you sure you want to clear the request history?')) {
            requestHistory = [];
            updateHistoryDisplay();
            showAlert('History cleared!', 'info');
        }
    }
    
    function loadApiDocumentation() {
        window.open('/api/docs/', '_blank');
    }
    
    function exportTestResults() {
        const data = {
            statistics: testStats,
            history: requestHistory,
            exportedAt: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `api-test-results-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }
</script>
{% endblock %} 