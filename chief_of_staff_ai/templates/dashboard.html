<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† AI Chief of Staff - Intelligence Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .intelligence-card {
            transition: all 0.3s ease;
        }
        .intelligence-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .strategic-importance-high {
            border-left: 4px solid #ef4444;
        }
        .strategic-importance-medium {
            border-left: 4px solid #f59e0b;
        }
        .strategic-importance-low {
            border-left: 4px solid #10b981;
        }
        .entity-connection {
            border: 1px solid #314d68;
            background: linear-gradient(135deg, #182734 0%, #223649 100%);
        }
        .insight-filter.active {
            background: #0b80ee !important;
            color: white !important;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.8), 0 0 30px rgba(59, 130, 246, 0.6); }
        }
        .processing {
            animation: pulse-glow 2s infinite;
        }
    </style>
</head>
<body class="bg-[#101a23] text-white min-h-screen">
    <div class="flex h-screen">
        <!-- Enhanced Sidebar Navigation -->
        <div class="layout-content-container flex h-full w-80 flex-col bg-gradient-to-b from-[#182734] to-[#101a23] border-r border-[#314d68]">
            <div class="px-6 py-8">
                <div class="flex items-center gap-4 mb-8">
                    <div class="text-3xl">üß†</div>
                    <div>
                        <h1 class="text-xl font-bold text-white">AI Chief of Staff</h1>
                        <p class="text-[#90aecb] text-sm">v2.0 Enhanced Intelligence</p>
                    </div>
                </div>
                
                <!-- User Intelligence Summary -->
                <div class="bg-[#223649] rounded-lg p-4 mb-6 border border-[#314d68]">
                    <h3 class="text-white font-semibold mb-3">Intelligence Overview</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-[#90aecb]">Entities:</span>
                            <span id="entityCount" class="text-white font-medium">Loading...</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-[#90aecb]">Topics:</span>
                            <span id="topicsCount" class="text-blue-400 font-medium">0 Topics</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-[#90aecb]">People:</span>
                            <span id="peopleCount" class="text-green-400 font-medium">0 People</span>
                        </div>
                        <div class="mt-3">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-[#90aecb]">Intelligence Score:</span>
                                <span id="intelligenceScore" class="text-yellow-400 font-bold">0</span>
                            </div>
                            <div class="w-full bg-[#314d68] rounded-full h-2">
                                <div id="intelligenceProgress" class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Navigation -->
                <div class="space-y-2 mb-8">
                    <div class="text-xs font-semibold text-[#90aecb] uppercase tracking-wider mb-3">Entity Intelligence</div>
                    <div class="space-y-1">
                        <a href="/people" class="nav-link flex items-center gap-3 px-3 py-2 cursor-pointer hover:bg-[#223649] rounded-full transition-colors">
                            <div class="text-white">üë•</div>
                            <p class="text-white text-sm font-medium leading-normal">Relationship Intelligence</p>
                        </a>
                        
                        <a href="/topics" class="nav-link flex items-center gap-3 px-3 py-2 cursor-pointer hover:bg-[#223649] rounded-full transition-colors">
                            <div class="text-white">üß†</div>
                            <p class="text-white text-sm font-medium leading-normal">Topics Brain</p>
                        </a>
                        
                        <a href="/tasks" class="nav-link flex items-center gap-3 px-3 py-2 cursor-pointer hover:bg-[#223649] rounded-full transition-colors">
                            <div class="text-white">‚ö°</div>
                            <p class="text-white text-sm font-medium leading-normal">Context Tasks</p>
                        </a>
                        
                        <a href="/analytics" class="nav-link flex items-center gap-3 px-3 py-2 cursor-pointer hover:bg-[#223649] rounded-full transition-colors">
                            <div class="text-white">üìä</div>
                            <p class="text-white text-sm font-medium leading-normal">Predictive Analytics</p>
                        </a>
                        
                        <a href="/real-time" class="nav-link flex items-center gap-3 px-3 py-2 cursor-pointer hover:bg-[#223649] rounded-full transition-colors">
                            <div class="text-white">‚ö°</div>
                            <p class="text-white text-sm font-medium leading-normal">Real-Time Processing</p>
                        </a>
                        
                        <a href="/search" class="nav-link flex items-center gap-3 px-3 py-2 cursor-pointer hover:bg-[#223649] rounded-full transition-colors">
                            <div class="text-white">üîç</div>
                            <p class="text-white text-sm font-medium leading-normal">Universal Search</p>
                        </a>
                    </div>
                </div>
                
                <!-- Real-Time Intelligence Actions -->
                <div class="space-y-3">
                    <button id="unifiedSyncBtn" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-full text-sm font-bold hover:from-blue-700 hover:to-purple-700 transition-all">
                        <span class="text-lg">üöÄ</span>
                        <span>Unified Intelligence Sync</span>
                    </button>
                    
                    <button id="generateInsightsBtn" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-[#223649] text-white rounded-full text-sm font-medium hover:bg-[#314d68] transition-colors">
                        <span>üß†</span>
                        <span>Generate Insights</span>
                    </button>
                    
                    <!-- AI Thinking Indicator -->
                    <div id="aiThinkingIndicator" class="hidden w-full flex items-center justify-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-full text-sm">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                        <span>AI is thinking...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Intelligence Dashboard -->
        <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
            <!-- Dashboard Header -->
            <div class="px-4 py-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h1 class="text-3xl font-bold text-white mb-2">üß† Intelligence Dashboard</h1>
                        <p class="text-[#90aecb] text-lg">Your AI-powered business intelligence center with real-time entity connections</p>
                    </div>
                    <div class="text-right">
                        <div class="text-[#90aecb] text-sm">Last Intelligence Update</div>
                        <div id="lastUpdateTime" class="text-white font-medium">--</div>
                    </div>
                </div>
                
                <!-- Real-Time Intelligence Metrics -->
                <div class="grid grid-cols-4 gap-4 mb-8">
                    <div class="bg-[#223649] p-4 rounded-lg border border-[#314d68] intelligence-card strategic-importance-high">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-[#90aecb]">Active Insights</h3>
                            <span class="text-2xl">üî•</span>
                        </div>
                        <p id="activeInsights" class="text-2xl font-bold text-white">0</p>
                        <p class="text-xs text-[#90aecb] mt-1">High-priority intelligence</p>
                    </div>

                    <div class="bg-[#223649] p-4 rounded-lg border border-[#314d68] intelligence-card strategic-importance-medium">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-[#90aecb]">Entity Network</h3>
                            <span class="text-2xl">üï∏Ô∏è</span>
                        </div>
                        <p id="entityNetworkSize" class="text-2xl font-bold text-white">0</p>
                        <p class="text-xs text-[#90aecb] mt-1">Connected entities</p>
                    </div>

                    <div class="bg-[#223649] p-4 rounded-lg border border-[#314d68] intelligence-card strategic-importance-medium">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-[#90aecb]">Topic Momentum</h3>
                            <span class="text-2xl">üìà</span>
                        </div>
                        <p id="topicMomentum" class="text-2xl font-bold text-white">0%</p>
                        <p class="text-xs text-[#90aecb] mt-1">Business velocity</p>
                    </div>

                    <div class="bg-[#223649] p-4 rounded-lg border border-[#314d68] intelligence-card strategic-importance-low">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-[#90aecb]">Relationship Score</h3>
                            <span class="text-2xl">üí´</span>
                        </div>
                        <p id="relationshipScore" class="text-2xl font-bold text-white">0</p>
                        <p class="text-xs text-[#90aecb] mt-1">Network strength</p>
                    </div>
                </div>
            </div>
            
            <!-- Proactive Intelligence Insights -->
            <div class="px-4 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-white">üö® Proactive Intelligence</h2>
                    <div class="flex gap-2">
                        <button class="insight-filter active px-3 py-1 text-sm rounded bg-[#0b80ee] text-white" data-filter="all">All</button>
                        <button class="insight-filter px-3 py-1 text-sm rounded bg-[#223649] text-[#90aecb] hover:bg-[#314d68]" data-filter="high">High Priority</button>
                        <button class="insight-filter px-3 py-1 text-sm rounded bg-[#223649] text-[#90aecb] hover:bg-[#314d68]" data-filter="relationship">Relationships</button>
                        <button class="insight-filter px-3 py-1 text-sm rounded bg-[#223649] text-[#90aecb] hover:bg-[#314d68]" data-filter="topics">Topics</button>
                    </div>
                </div>
                
                <div id="proactiveInsightsContainer" class="space-y-3">
                    <!-- Insights will be loaded here -->
                    <div class="text-center py-8 text-[#90aecb]">
                        <div class="text-4xl mb-2">üß†</div>
                        <p>AI is analyzing your business intelligence...</p>
                        <p class="text-sm mt-1">Proactive insights will appear here</p>
                    </div>
                </div>
            </div>
            
            <!-- Entity Intelligence Network -->
            <div class="px-4 mb-8">
                <h2 class="text-xl font-semibold text-white mb-4">üï∏Ô∏è Entity Intelligence Network</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Topics Brain -->
                    <div class="bg-[#223649] rounded-lg border border-[#314d68] p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-white font-semibold">üß† Topics Brain</h3>
                            <span class="text-xs bg-purple-600 text-white px-2 py-1 rounded-full">Central Intelligence</span>
                        </div>
                        
                        <div id="topicsBrainContainer" class="space-y-3 max-h-64 overflow-y-auto">
                            <!-- Topics will be loaded here -->
                        </div>
                        
                        <div class="mt-4 pt-3 border-t border-[#314d68]">
                            <button class="w-full text-center text-[#0b80ee] text-sm hover:underline" onclick="location.href='/topics'">
                                View Full Topics Intelligence ‚Üí
                            </button>
                        </div>
                    </div>
                    
                    <!-- Relationship Intelligence -->
                    <div class="bg-[#223649] rounded-lg border border-[#314d68] p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-white font-semibold">üë• Relationship Intelligence</h3>
                            <span class="text-xs bg-green-600 text-white px-2 py-1 rounded-full">Dynamic</span>
                        </div>
                        
                        <div id="relationshipIntelContainer" class="space-y-3 max-h-64 overflow-y-auto">
                            <!-- Relationships will be loaded here -->
                        </div>
                        
                        <div class="mt-4 pt-3 border-t border-[#314d68]">
                            <button class="w-full text-center text-[#0b80ee] text-sm hover:underline" onclick="location.href='/people'">
                                View Full Relationship Map ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Context-Aware Tasks -->
            <div class="px-4 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-white">‚ö° Context-Aware Tasks</h2>
                    <div class="text-sm text-[#90aecb]">
                        <span id="tasksWithContext">0</span> tasks with business context
                    </div>
                </div>
                
                <div id="contextTasksContainer" class="space-y-3">
                    <!-- Context tasks will be loaded here -->
                </div>
                
                <div class="mt-4 text-center">
                    <button class="text-[#0b80ee] text-sm hover:underline" onclick="location.href='/tasks'">
                        View All Context Tasks ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- AI Chat Interface -->
            <div class="px-4 py-6 border-t border-[#314d68]">
                <h2 class="text-xl font-semibold text-white mb-4">üí¨ Intelligence Assistant</h2>
                
                <div class="bg-[#223649] rounded-lg border border-[#314d68] p-4">
                    <div id="chatHistory" class="space-y-3 mb-4 max-h-64 overflow-y-auto">
                        <div class="text-[#90aecb] text-sm text-center py-4">
                            Ask me anything about your business intelligence, relationships, or strategic insights...
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <input id="chatInput" type="text" 
                               placeholder="Ask about your business intelligence..." 
                               class="flex-1 bg-[#101a23] text-white border border-[#314d68] rounded-lg px-4 py-2 focus:outline-none focus:border-[#0b80ee] transition-colors">
                        <button id="sendChatBtn" 
                                class="px-6 py-2 bg-[#0b80ee] text-white rounded-lg hover:bg-blue-600 transition-colors">
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state for real-time intelligence
        let intelligenceState = {
            entities: { topics: 0, people: 0, tasks: 0, events: 0 },
            insights: [],
            relationships: [],
            processing: false,
            lastUpdate: null
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeIntelligenceDashboard();
            setupEventListeners();
            startRealTimeUpdates();
        });

        function initializeIntelligenceDashboard() {
            loadIntelligenceMetrics();
            loadProactiveInsights();
            loadEntityNetwork();
            loadContextTasks();
            updateLastUpdateTime();
        }

        function setupEventListeners() {
            // Unified sync button
            document.getElementById('unifiedSyncBtn').addEventListener('click', runUnifiedIntelligenceSync);
            
            // Generate insights button
            document.getElementById('generateInsightsBtn').addEventListener('click', generateProactiveInsights);
            
            // Chat functionality
            document.getElementById('sendChatBtn').addEventListener('click', sendIntelligenceChat);
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendIntelligenceChat();
            });
            
            // Insight filters
            document.querySelectorAll('.insight-filter').forEach(btn => {
                btn.addEventListener('click', function() {
                    filterInsights(this.dataset.filter);
                    updateFilterButtons(this);
                });
            });
        }

        function startRealTimeUpdates() {
            // Update metrics every 30 seconds
            setInterval(() => {
                if (!intelligenceState.processing) {
                    loadIntelligenceMetrics();
                    updateLastUpdateTime();
                }
            }, 30000);
            
            // Check for new insights every 60 seconds
            setInterval(() => {
                loadProactiveInsights();
            }, 60000);
        }

        async function runUnifiedIntelligenceSync() {
            const btn = document.getElementById('unifiedSyncBtn');
            const originalText = btn.innerHTML;
            
            try {
                intelligenceState.processing = true;
                showProcessingStatus(true);
                
                btn.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div> Processing Intelligence...';
                btn.disabled = true;
                
                // Show AI thinking indicator
                document.getElementById('aiThinkingIndicator').classList.remove('hidden');
                
                const response = await fetch('/api/enhanced-unified-sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        max_emails: 25,
                        days_back: 7,
                        enable_real_time: true,
                        force_refresh: false
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update intelligence state
                    intelligenceState.entities = data.entity_intelligence?.entity_summary || intelligenceState.entities;
                    intelligenceState.insights = data.proactive_insights || [];
                    
                    // Show detailed success message
                    showIntelligenceSuccess(data);
                    
                    // Refresh all dashboard components
                    await refreshIntelligenceDashboard();
                    
                } else {
                    showError('Intelligence sync failed: ' + (data.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Intelligence sync error:', error);
                showError('Failed to sync intelligence. Please try again.');
            } finally {
                intelligenceState.processing = false;
                showProcessingStatus(false);
                btn.innerHTML = originalText;
                btn.disabled = false;
                document.getElementById('aiThinkingIndicator').classList.add('hidden');
            }
        }

        async function loadIntelligenceMetrics() {
            try {
                // Get enhanced metrics from new API endpoints
                const response = await fetch('/api/entities/metrics');
                const data = await response.json();
                
                if (data.success) {
                    updateIntelligenceMetrics(data.metrics);
                }
            } catch (error) {
                console.error('Failed to load intelligence metrics:', error);
            }
        }

        function updateIntelligenceMetrics(metrics) {
            // Update entity counts
            document.getElementById('entityCount').textContent = metrics.total_entities || 0;
            document.getElementById('topicsCount').textContent = `${metrics.topics || 0} Topics`;
            document.getElementById('peopleCount').textContent = `${metrics.people || 0} People`;
            
            // Update intelligence score (0-100)
            const score = Math.round((metrics.intelligence_quality || 0) * 100);
            document.getElementById('intelligenceScore').textContent = score;
            document.getElementById('intelligenceProgress').style.width = score + '%';
            
            // Update other metrics
            document.getElementById('activeInsights').textContent = metrics.active_insights || 0;
            document.getElementById('entityNetworkSize').textContent = metrics.entity_relationships || 0;
            document.getElementById('topicMomentum').textContent = Math.round((metrics.topic_momentum || 0) * 100) + '%';
            document.getElementById('relationshipScore').textContent = Math.round((metrics.relationship_density || 0) * 100);
        }

        async function loadProactiveInsights() {
            try {
                const response = await fetch('/api/intelligence/insights?status=new&limit=10');
                const data = await response.json();
                
                if (data.success) {
                    displayProactiveInsights(data.insights);
                }
            } catch (error) {
                console.error('Failed to load proactive insights:', error);
            }
        }

        function displayProactiveInsights(insights) {
            const container = document.getElementById('proactiveInsightsContainer');
            
            if (!insights || insights.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-[#90aecb]">
                        <div class="text-4xl mb-2">üß†</div>
                        <p>No new insights available</p>
                        <p class="text-sm mt-1">Process more data to generate intelligence</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = insights.map(insight => createInsightCard(insight)).join('');
        }

        function createInsightCard(insight) {
            const priorityColors = {
                'high': 'border-red-500 bg-red-500 bg-opacity-10',
                'medium': 'border-yellow-500 bg-yellow-500 bg-opacity-10',
                'low': 'border-green-500 bg-green-500 bg-opacity-10'
            };
            
            const typeEmojis = {
                'relationship_alert': 'üë•',
                'topic_momentum': 'üìà',
                'meeting_prep': 'üìÖ',
                'project_attention': 'üìã',
                'important_contact': '‚≠ê',
                'urgent_task': '‚ö°'
            };
            
            const colorClass = priorityColors[insight.priority] || priorityColors['medium'];
            const emoji = typeEmojis[insight.insight_type] || 'üß†';
            
            return `
                <div class="intelligence-card bg-[#182734] rounded-lg border ${colorClass} p-4" data-insight-type="${insight.insight_type}" data-priority="${insight.priority}">
                    <div class="flex items-start gap-4">
                        <div class="text-2xl">${emoji}</div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between gap-3">
                                <h3 class="text-white font-medium leading-tight">${escapeHtml(insight.title)}</h3>
                                <div class="flex gap-2 shrink-0">
                                    <span class="text-xs px-2 py-1 rounded-full ${getPriorityColor(insight.priority)}">${insight.priority.toUpperCase()}</span>
                                    <span class="text-xs px-2 py-1 rounded-full bg-[#314d68] text-[#90aecb]">${Math.round(insight.confidence * 100)}%</span>
                                </div>
                            </div>
                            <p class="text-[#90aecb] text-sm mt-2 leading-relaxed">${escapeHtml(insight.description)}</p>
                            <div class="flex items-center justify-between mt-3">
                                <span class="text-xs text-[#78879a]">${formatTimeAgo(insight.created_at)}</span>
                                <div class="flex gap-2">
                                    <button onclick="markInsightFeedback(${insight.id}, 'helpful')" class="text-xs px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded">üëç Helpful</button>
                                    <button onclick="markInsightFeedback(${insight.id}, 'not_helpful')" class="text-xs px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded">üëé Not helpful</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadEntityNetwork() {
            try {
                // Load topics brain
                const topicsResponse = await fetch('/api/entities/topics?limit=5');
                const topicsData = await topicsResponse.json();
                
                if (topicsData.success) {
                    displayTopicsBrain(topicsData.topics);
                }
                
                // Load relationship intelligence
                const peopleResponse = await fetch('/api/people?limit=5');
                const peopleData = await peopleResponse.json();
                
                if (peopleData.success) {
                    displayRelationshipIntelligence(peopleData.people);
                }
                
            } catch (error) {
                console.error('Failed to load entity network:', error);
            }
        }

        function displayTopicsBrain(topics) {
            const container = document.getElementById('topicsBrainContainer');
            
            if (!topics || topics.length === 0) {
                container.innerHTML = '<div class="text-[#90aecb] text-sm text-center py-4">No topics discovered yet</div>';
                return;
            }
            
            container.innerHTML = topics.map(topic => `
                <div class="entity-connection rounded-lg p-3 hover:bg-[#314d68] transition-colors cursor-pointer">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <h4 class="text-white font-medium text-sm truncate">${escapeHtml(topic.name)}</h4>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs text-[#90aecb]">${topic.total_mentions} mentions</span>
                                ${topic.is_official ? '<span class="text-xs bg-blue-600 text-white px-2 py-1 rounded">Official</span>' : ''}
                            </div>
                        </div>
                        <div class="text-lg">${(topic.strategic_importance || 0) > 0.7 ? 'üî•' : (topic.strategic_importance || 0) > 0.4 ? 'üìà' : 'üìä'}</div>
                    </div>
                    ${topic.total_connections && topic.total_connections > 0 ? `
                        <div class="mt-2 text-xs text-[#78879a]">
                            Connected: ${topic.connected_people} people, ${topic.related_tasks} tasks
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function displayRelationshipIntelligence(people) {
            const container = document.getElementById('relationshipIntelContainer');
            
            if (!people || people.length === 0) {
                container.innerHTML = '<div class="text-[#90aecb] text-sm text-center py-4">No relationship data yet</div>';
                return;
            }
            
            container.innerHTML = people.map(person => `
                <div class="entity-connection rounded-lg p-3 hover:bg-[#314d68] transition-colors cursor-pointer">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-xs font-bold">
                            ${getInitials(person.name)}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-white font-medium text-sm truncate">${escapeHtml(person.name)}</h4>
                            <div class="text-xs text-[#90aecb] truncate">${escapeHtml(person.company || 'Unknown company')}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-[#90aecb]">${person.total_interactions} interactions</div>
                            <div class="text-xs text-yellow-400">${Math.round((person.importance_level || 0) * 100)}% importance</div>
                        </div>
                    </div>
                    ${person.engagement_score ? `
                        <div class="mt-2 text-xs text-[#78879a]">
                            Engagement: ${Math.round(person.engagement_score * 100)}% ‚Ä¢ 
                            Topics: ${person.topic_connections}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        async function loadContextTasks() {
            try {
                const response = await fetch('/api/tasks?limit=5&with_context=true');
                const data = await response.json();
                
                if (data.success) {
                    displayContextTasks(data.tasks);
                    document.getElementById('tasksWithContext').textContent = data.tasks.filter(t => t.context_story).length;
                }
            } catch (error) {
                console.error('Failed to load context tasks:', error);
            }
        }

        function displayContextTasks(tasks) {
            const container = document.getElementById('contextTasksContainer');
            
            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<div class="text-[#90aecb] text-sm text-center py-4">No context tasks yet</div>';
                return;
            }
            
            container.innerHTML = tasks.map(task => `
                <div class="bg-[#223649] rounded-lg p-4 border border-[#314d68]">
                    <div class="flex items-start justify-between gap-3">
                        <div class="flex-1">
                            <h4 class="text-white font-medium mb-1">${escapeHtml(task.description)}</h4>
                            ${task.context_story ? `<p class="text-[#90aecb] text-sm mb-2">${escapeHtml(task.context_story)}</p>` : ''}
                            <div class="flex items-center gap-2">
                                <span class="text-xs px-2 py-1 rounded ${getPriorityColor(task.priority)}">${task.priority}</span>
                                <span class="text-xs text-[#78879a]">${task.status}</span>
                            </div>
                        </div>
                        <div class="text-lg">${task.priority === 'high' ? 'üî•' : task.priority === 'medium' ? '‚ö°' : 'üìã'}</div>
                    </div>
                </div>
            `).join('');
        }

        async function generateProactiveInsights() {
            try {
                const response = await fetch('/api/intelligence/trigger-insights', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Proactive insight generation triggered. New insights will appear shortly.');
                    setTimeout(() => loadProactiveInsights(), 3000);
                } else {
                    showError('Failed to trigger insights: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to trigger insights:', error);
                showError('Failed to trigger insight generation.');
            }
        }

        async function sendIntelligenceChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const chatHistory = document.getElementById('chatHistory');
            
            // Add user message
            chatHistory.innerHTML += `
                <div class="flex gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white text-xs font-bold">U</div>
                    <div class="flex-1">
                        <p class="text-white text-sm">${escapeHtml(message)}</p>
                    </div>
                </div>
            `;
            
            input.value = '';
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Add AI response
                    chatHistory.innerHTML += `
                        <div class="flex gap-3">
                            <div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center text-white text-xs font-bold">AI</div>
                            <div class="flex-1">
                                <p class="text-[#90aecb] text-sm">${escapeHtml(data.reply)}</p>
                                ${data.enhanced_context ? '<span class="text-xs text-green-400">Enhanced with business context</span>' : ''}
                            </div>
                        </div>
                    `;
                } else {
                    chatHistory.innerHTML += `
                        <div class="flex gap-3">
                            <div class="w-8 h-8 rounded-full bg-red-600 flex items-center justify-center text-white text-xs font-bold">!</div>
                            <div class="flex-1">
                                <p class="text-red-400 text-sm">Sorry, I couldn't process that request.</p>
                            </div>
                        </div>
                    `;
                }
                
                chatHistory.scrollTop = chatHistory.scrollHeight;
                
            } catch (error) {
                console.error('Chat error:', error);
            }
        }

        async function refreshIntelligenceDashboard() {
            await Promise.all([
                loadIntelligenceMetrics(),
                loadProactiveInsights(),
                loadEntityNetwork(),
                loadContextTasks()
            ]);
        }

        function filterInsights(filter) {
            const insights = document.querySelectorAll('[data-insight-type]');
            
            insights.forEach(insight => {
                const type = insight.dataset.insightType;
                const priority = insight.dataset.priority;
                
                if (filter === 'all' || 
                    (filter === 'high' && priority === 'high') ||
                    (filter === 'relationship' && type.includes('relationship')) ||
                    (filter === 'topics' && type.includes('topic'))) {
                    insight.style.display = 'block';
                } else {
                    insight.style.display = 'none';
                }
            });
        }

        function updateFilterButtons(activeBtn) {
            document.querySelectorAll('.insight-filter').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('bg-[#223649]', 'text-[#90aecb]');
                btn.classList.remove('bg-[#0b80ee]', 'text-white');
            });
            
            activeBtn.classList.add('active');
            activeBtn.classList.add('bg-[#0b80ee]', 'text-white');
            activeBtn.classList.remove('bg-[#223649]', 'text-[#90aecb]');
        }

        async function markInsightFeedback(insightId, feedback) {
            try {
                const response = await fetch('/api/intelligence/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ insight_id: insightId, feedback })
                });
                
                if (response.ok) {
                    showSuccess(`Feedback recorded: ${feedback}`);
                }
            } catch (error) {
                console.error('Failed to record feedback:', error);
            }
        }

        function updateLastUpdateTime() {
            document.getElementById('lastUpdateTime').textContent = new Date().toLocaleTimeString();
        }

        function showProcessingStatus(processing) {
            const cards = document.querySelectorAll('.intelligence-card');
            cards.forEach(card => {
                if (processing) {
                    card.classList.add('processing');
                } else {
                    card.classList.remove('processing');
                }
            });
        }

        function showIntelligenceSuccess(data) {
            const message = `Intelligence sync complete! Created ${data.entities_created?.people || 0} people, ${data.entities_created?.topics || 0} topics, ${data.entities_created?.tasks || 0} tasks. Generated ${data.proactive_insights?.length || 0} insights.`;
            showSuccess(message);
        }

        function showSuccess(message) {
            // Simple success notification - could be enhanced with a toast library
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        function showError(message) {
            // Simple error notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getPriorityColor(priority) {
            const colors = {
                'high': 'bg-red-600 text-white',
                'medium': 'bg-yellow-600 text-white',
                'low': 'bg-green-600 text-white'
            };
            return colors[priority] || colors['medium'];
        }

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        function formatTimeAgo(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
            return `${Math.floor(diffMins / 1440)}d ago`;
        }
    </script>
</body>
</html> 