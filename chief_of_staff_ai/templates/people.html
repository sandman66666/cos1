{% extends "base.html" %}

{% block title %}People Management - AI Chief of Staff{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">
            <i class="fas fa-users me-2"></i>
            People Management
        </h1>
        <p class="text-muted mb-0">Manage your professional network and relationships</p>
    </div>
    <div>
        <button class="btn btn-enhanced" onclick="openAddPersonModal()">
            <i class="fas fa-plus me-2"></i>Add Person
        </button>
        <button class="btn btn-outline-info ms-2" onclick="syncFromEmails()">
            <i class="fas fa-sync me-2"></i>Sync from Emails
        </button>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="stat-card">
            <div class="d-flex justify-content-between">
                <div>
                    <div class="stat-value" id="totalPeople">0</div>
                    <div class="stat-label">Total People</div>
                </div>
                <div class="align-self-center">
                    <i class="fas fa-users fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="d-flex justify-content-between">
                <div>
                    <div class="stat-value" id="highImportance">0</div>
                    <div class="stat-label">High Importance</div>
                </div>
                <div class="align-self-center">
                    <i class="fas fa-star fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <div class="d-flex justify-content-between">
                <div>
                    <div class="stat-value" id="recentlyActive">0</div>
                    <div class="stat-label">Recently Active</div>
                </div>
                <div class="align-self-center">
                    <i class="fas fa-clock fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
            <div class="d-flex justify-content-between">
                <div>
                    <div class="stat-value" id="totalCompanies">0</div>
                    <div class="stat-label">Companies</div>
                </div>
                <div class="align-self-center">
                    <i class="fas fa-building fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="searchInput" class="form-label">Search People</label>
                        <div class="input-group">
                            <input type="text" id="searchInput" class="form-control" placeholder="Name, email, or company..." onkeyup="filterPeople()">
                            <button class="btn btn-outline-primary" onclick="filterPeople()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="companyFilter" class="form-label">Company</label>
                        <select id="companyFilter" class="form-select" onchange="filterPeople()">
                            <option value="">All Companies</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="importanceFilter" class="form-label">Importance</label>
                        <select id="importanceFilter" class="form-select" onchange="filterPeople()">
                            <option value="">All Levels</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="fas fa-times me-2"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- People List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>People Directory
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleView('grid')" id="gridViewBtn">
                        <i class="fas fa-th"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary ms-1" onclick="toggleView('list')" id="listViewBtn">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="peopleContainer">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-users fa-3x mb-3"></i>
                        <p>Loading people...</p>
                    </div>
                </div>
                
                <!-- Pagination -->
                <nav aria-label="People pagination" id="paginationContainer" style="display: none;">
                    <ul class="pagination justify-content-center">
                        <!-- Pagination will be inserted here -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Person Modal -->
<div class="modal fade" id="personModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="personModalTitle">
                    <i class="fas fa-user me-2"></i>Add New Person
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="personForm">
                    <input type="hidden" id="personId" value="">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="personName" class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="personName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="personEmail" class="form-label">Email Address *</label>
                            <input type="email" class="form-control" id="personEmail" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="personCompany" class="form-label">Company</label>
                            <input type="text" class="form-control" id="personCompany">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="personTitle" class="form-label">Job Title</label>
                            <input type="text" class="form-control" id="personTitle">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="personImportance" class="form-label">Importance Level</label>
                            <select class="form-select" id="personImportance">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="personLinkedIn" class="form-label">LinkedIn URL</label>
                            <input type="url" class="form-control" id="personLinkedIn">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="personBio" class="form-label">Bio/Notes</label>
                        <textarea class="form-control" id="personBio" rows="3" placeholder="Additional information about this person..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-enhanced" onclick="savePerson()">
                    <i class="fas fa-save me-2"></i>Save Person
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Person Details Modal -->
<div class="modal fade" id="personDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="personDetailsTitle">
                    <i class="fas fa-user me-2"></i>Person Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="personDetailsContent">
                <!-- Person details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-primary" onclick="editPersonFromDetails()">
                    <i class="fas fa-edit me-2"></i>Edit
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .person-card {
        transition: all 0.3s ease;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        margin-bottom: 1rem;
        cursor: pointer;
    }
    
    .person-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-color);
    }
    
    .person-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
    }
    
    .importance-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 0.75rem;
    }
    
    .person-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
    }
    
    .person-list .person-card {
        margin-bottom: 0.5rem;
    }
    
    .relationship-tag {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 15px;
        font-size: 0.75rem;
        margin: 0.1rem;
        display: inline-block;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // People management functionality
    let currentPeople = [];
    let filteredPeople = [];
    let currentView = 'grid';
    let currentPage = 1;
    let itemsPerPage = 12;
    let currentEditingPerson = null;
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadPeople();
        loadCompanies();
    });
    
    // Load people from API
    async function loadPeople() {
        try {
            showLoading();
            const response = await axios.get('/api/entities/people', {
                params: {
                    limit: 1000,
                    include_relationships: true
                }
            });
            
            hideLoading();
            
            if (response.data.success) {
                currentPeople = response.data.data.people || [];
                filteredPeople = [...currentPeople];
                updateStatistics();
                renderPeople();
            } else {
                showAlert('Failed to load people: ' + response.data.error, 'danger');
            }
        } catch (error) {
            hideLoading();
            showAlert('Error loading people: ' + error.message, 'danger');
        }
    }
    
    // Update statistics
    function updateStatistics() {
        document.getElementById('totalPeople').textContent = currentPeople.length;
        
        const highImportance = currentPeople.filter(p => p.importance_level >= 0.7).length;
        document.getElementById('highImportance').textContent = highImportance;
        
        const recentlyActive = currentPeople.filter(p => {
            if (!p.last_contact) return false;
            const lastContact = new Date(p.last_contact);
            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
            return lastContact > thirtyDaysAgo;
        }).length;
        document.getElementById('recentlyActive').textContent = recentlyActive;
        
        const companies = new Set(currentPeople.filter(p => p.company).map(p => p.company));
        document.getElementById('totalCompanies').textContent = companies.size;
    }
    
    // Load companies for filter
    function loadCompanies() {
        const companies = new Set(currentPeople.filter(p => p.company).map(p => p.company));
        const companyFilter = document.getElementById('companyFilter');
        
        companyFilter.innerHTML = '<option value="">All Companies</option>';
        [...companies].sort().forEach(company => {
            companyFilter.innerHTML += `<option value="${company}">${company}</option>`;
        });
    }
    
    // Filter people based on search and filters
    function filterPeople() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const companyFilter = document.getElementById('companyFilter').value;
        const importanceFilter = document.getElementById('importanceFilter').value;
        
        filteredPeople = currentPeople.filter(person => {
            const matchesSearch = !searchTerm || 
                person.name.toLowerCase().includes(searchTerm) ||
                person.email_address.toLowerCase().includes(searchTerm) ||
                (person.company && person.company.toLowerCase().includes(searchTerm));
            
            const matchesCompany = !companyFilter || person.company === companyFilter;
            
            let matchesImportance = true;
            if (importanceFilter) {
                const importance = person.importance_level || 0;
                switch (importanceFilter) {
                    case 'high':
                        matchesImportance = importance >= 0.7;
                        break;
                    case 'medium':
                        matchesImportance = importance >= 0.3 && importance < 0.7;
                        break;
                    case 'low':
                        matchesImportance = importance < 0.3;
                        break;
                }
            }
            
            return matchesSearch && matchesCompany && matchesImportance;
        });
        
        currentPage = 1;
        renderPeople();
    }
    
    // Clear all filters
    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('companyFilter').value = '';
        document.getElementById('importanceFilter').value = '';
        filteredPeople = [...currentPeople];
        currentPage = 1;
        renderPeople();
    }
    
    // Toggle between grid and list view
    function toggleView(view) {
        currentView = view;
        document.getElementById('gridViewBtn').classList.toggle('btn-primary', view === 'grid');
        document.getElementById('gridViewBtn').classList.toggle('btn-outline-secondary', view !== 'grid');
        document.getElementById('listViewBtn').classList.toggle('btn-primary', view === 'list');
        document.getElementById('listViewBtn').classList.toggle('btn-outline-secondary', view !== 'list');
        renderPeople();
    }
    
    // Render people based on current view and pagination
    function renderPeople() {
        const container = document.getElementById('peopleContainer');
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const peopleToShow = filteredPeople.slice(startIndex, endIndex);
        
        if (peopleToShow.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-users fa-3x mb-3"></i>
                    <p>No people found matching your criteria.</p>
                </div>
            `;
            document.getElementById('paginationContainer').style.display = 'none';
            return;
        }
        
        if (currentView === 'grid') {
            container.className = 'person-grid';
            container.innerHTML = peopleToShow.map(person => createPersonCard(person)).join('');
        } else {
            container.className = 'person-list';
            container.innerHTML = peopleToShow.map(person => createPersonListItem(person)).join('');
        }
        
        renderPagination();
    }
    
    // Create person card for grid view
    function createPersonCard(person) {
        const initials = person.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        const importanceColor = getImportanceColor(person.importance_level);
        const importanceText = getImportanceText(person.importance_level);
        
        return `
            <div class="person-card p-3 position-relative" onclick="viewPersonDetails(${person.id})">
                <span class="importance-badge badge bg-${importanceColor}">${importanceText}</span>
                <div class="d-flex align-items-center mb-3">
                    <div class="person-avatar me-3">${initials}</div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${person.name}</h6>
                        <small class="text-muted">${person.email_address}</small>
                    </div>
                </div>
                <div class="mb-2">
                    ${person.title ? `<div class="small"><strong>${person.title}</strong></div>` : ''}
                    ${person.company ? `<div class="small text-muted">${person.company}</div>` : ''}
                </div>
                <div class="small text-muted">
                    Last contact: ${person.last_contact ? new Date(person.last_contact).toLocaleDateString() : 'Never'}
                </div>
            </div>
        `;
    }
    
    // Create person list item for list view
    function createPersonListItem(person) {
        const initials = person.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        const importanceColor = getImportanceColor(person.importance_level);
        const importanceText = getImportanceText(person.importance_level);
        
        return `
            <div class="person-card p-3" onclick="viewPersonDetails(${person.id})">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <div class="person-avatar me-3">${initials}</div>
                            <div>
                                <h6 class="mb-1">${person.name}</h6>
                                <small class="text-muted">${person.email_address}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div>
                            ${person.title ? `<div class="small"><strong>${person.title}</strong></div>` : ''}
                            ${person.company ? `<div class="small text-muted">${person.company}</div>` : ''}
                        </div>
                    </div>
                    <div class="col-md-2">
                        <span class="badge bg-${importanceColor}">${importanceText}</span>
                    </div>
                    <div class="col-md-1 text-end">
                        <i class="fas fa-chevron-right text-muted"></i>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Helper functions for importance level
    function getImportanceColor(level) {
        if (level >= 0.7) return 'danger';
        if (level >= 0.3) return 'warning';
        return 'info';
    }
    
    function getImportanceText(level) {
        if (level >= 0.7) return 'High';
        if (level >= 0.3) return 'Medium';
        return 'Low';
    }
    
    // Render pagination
    function renderPagination() {
        const totalPages = Math.ceil(filteredPeople.length / itemsPerPage);
        const paginationContainer = document.getElementById('paginationContainer');
        
        if (totalPages <= 1) {
            paginationContainer.style.display = 'none';
            return;
        }
        
        paginationContainer.style.display = 'block';
        const pagination = paginationContainer.querySelector('.pagination');
        
        let paginationHTML = `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
            </li>
        `;
        
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }
        
        paginationHTML += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
            </li>
        `;
        
        pagination.innerHTML = paginationHTML;
    }
    
    // Change page
    function changePage(page) {
        const totalPages = Math.ceil(filteredPeople.length / itemsPerPage);
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            renderPeople();
        }
    }
    
    // Modal functions
    function openAddPersonModal() {
        currentEditingPerson = null;
        document.getElementById('personModalTitle').innerHTML = '<i class="fas fa-user me-2"></i>Add New Person';
        document.getElementById('personForm').reset();
        document.getElementById('personId').value = '';
        new bootstrap.Modal(document.getElementById('personModal')).show();
    }
    
    function editPersonFromDetails() {
        if (currentEditingPerson) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('personDetailsModal'));
            modal.hide();
            editPerson(currentEditingPerson);
        }
    }
    
    function editPerson(person) {
        currentEditingPerson = person;
        document.getElementById('personModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Person';
        
        // Populate form
        document.getElementById('personId').value = person.id;
        document.getElementById('personName').value = person.name;
        document.getElementById('personEmail').value = person.email_address;
        document.getElementById('personCompany').value = person.company || '';
        document.getElementById('personTitle').value = person.title || '';
        document.getElementById('personLinkedIn').value = person.linkedin_url || '';
        document.getElementById('personBio').value = person.bio || '';
        
        // Set importance level
        let importance = 'medium';
        if (person.importance_level >= 0.7) importance = 'high';
        else if (person.importance_level < 0.3) importance = 'low';
        document.getElementById('personImportance').value = importance;
        
        new bootstrap.Modal(document.getElementById('personModal')).show();
    }
    
    // Save person
    async function savePerson() {
        const form = document.getElementById('personForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        const personData = {
            name: document.getElementById('personName').value,
            email: document.getElementById('personEmail').value,
            company: document.getElementById('personCompany').value,
            title: document.getElementById('personTitle').value,
            linkedin_url: document.getElementById('personLinkedIn').value,
            bio: document.getElementById('personBio').value,
            importance: document.getElementById('personImportance').value
        };
        
        const personId = document.getElementById('personId').value;
        
        try {
            showLoading();
            let response;
            
            if (personId) {
                // Update existing person
                response = await axios.put(`/api/entities/people/${personId}`, personData);
            } else {
                // Create new person
                response = await axios.post('/api/entities/people', personData);
            }
            
            hideLoading();
            
            if (response.data.success) {
                showAlert(`Person ${personId ? 'updated' : 'created'} successfully!`, 'success');
                bootstrap.Modal.getInstance(document.getElementById('personModal')).hide();
                loadPeople(); // Reload the list
            } else {
                showAlert(`Failed to ${personId ? 'update' : 'create'} person: ` + response.data.error, 'danger');
            }
        } catch (error) {
            hideLoading();
            showAlert(`Error ${personId ? 'updating' : 'creating'} person: ` + error.message, 'danger');
        }
    }
    
    // View person details
    async function viewPersonDetails(personId) {
        try {
            showLoading();
            const response = await axios.get(`/api/entities/people/${personId}`, {
                params: { include_relationships: true }
            });
            
            hideLoading();
            
            if (response.data.success) {
                const person = response.data.data.person;
                currentEditingPerson = person;
                
                document.getElementById('personDetailsTitle').innerHTML = `
                    <i class="fas fa-user me-2"></i>${person.name}
                `;
                
                document.getElementById('personDetailsContent').innerHTML = createPersonDetailsHTML(person);
                new bootstrap.Modal(document.getElementById('personDetailsModal')).show();
            } else {
                showAlert('Failed to load person details: ' + response.data.error, 'danger');
            }
        } catch (error) {
            hideLoading();
            showAlert('Error loading person details: ' + error.message, 'danger');
        }
    }
    
    // Create person details HTML
    function createPersonDetailsHTML(person) {
        const initials = person.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        const importanceColor = getImportanceColor(person.importance_level);
        const importanceText = getImportanceText(person.importance_level);
        
        return `
            <div class="row">
                <div class="col-md-3 text-center mb-4">
                    <div class="person-avatar mx-auto mb-3" style="width: 100px; height: 100px; font-size: 2rem;">
                        ${initials}
                    </div>
                    <span class="badge bg-${importanceColor} fs-6">${importanceText} Importance</span>
                </div>
                <div class="col-md-9">
                    <h4>${person.name}</h4>
                    <p class="text-muted mb-3">${person.email_address}</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Company:</strong> ${person.company || 'Not specified'}<br>
                            <strong>Title:</strong> ${person.title || 'Not specified'}<br>
                            <strong>Last Contact:</strong> ${person.last_contact ? new Date(person.last_contact).toLocaleDateString() : 'Never'}
                        </div>
                        <div class="col-md-6">
                            <strong>Total Emails:</strong> ${person.email_count || 0}<br>
                            <strong>Created:</strong> ${person.created_at ? new Date(person.created_at).toLocaleDateString() : 'Unknown'}<br>
                            <strong>LinkedIn:</strong> ${person.linkedin_url ? `<a href="${person.linkedin_url}" target="_blank">View Profile</a>` : 'Not provided'}
                        </div>
                    </div>
                    
                    ${person.bio ? `
                        <div class="mt-3">
                            <strong>Bio/Notes:</strong>
                            <p>${person.bio}</p>
                        </div>
                    ` : ''}
                    
                    ${person.relationships && person.relationships.length > 0 ? `
                        <div class="mt-3">
                            <strong>Relationships:</strong><br>
                            ${person.relationships.map(rel => `<span class="relationship-tag">${rel.type}: ${rel.name}</span>`).join(' ')}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    // Sync from emails
    async function syncFromEmails() {
        try {
            showLoading();
            showAlert('Syncing people from emails... This may take a moment.', 'info');
            
            const response = await axios.post('/api/entities/people/sync-from-emails');
            
            hideLoading();
            
            if (response.data.success) {
                const syncData = response.data.data;
                showAlert(`Sync completed! Added ${syncData.new_people} new people, updated ${syncData.updated_people} existing.`, 'success');
                loadPeople();
            } else {
                showAlert('Sync failed: ' + response.data.error, 'danger');
            }
        } catch (error) {
            hideLoading();
            showAlert('Sync error: ' + error.message, 'danger');
        }
    }
</script>
{% endblock %} 